<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="description" content="Some tests with Web Bluetooth.">
    <title>Web Bluetooth Test</title>
    <script>
      // Add a global error event listener early on in the page load, to help ensure that browsers
      // which don't support specific functionality still end up displaying a meaningful message.
      window.addEventListener('error', function(error) {
        if (ChromeSamples && ChromeSamples.setStatus) {
          console.error(error);
          ChromeSamples.setStatus(error.message + ' (Your browser may not support this feature.)');
          error.preventDefault();
        }
      });
    </script>
    <link rel="icon" sizes="192x192" href="favicon.png">
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <h1>Some tests with Web Bluetooth</h1>
    <p>Note: Some code is used from the official <a href="https://googlechrome.github.io/samples/web-bluetooth/index.html">Web Bluetooth Samples</a></p>
    <p>The <a href="https://github.com/WebBluetoothCG/web-bluetooth">Web Bluetooth API</a> lets websites discover and communicate with devices over the 
      Bluetooth 4 wireless standard using the Generic Attribute Profile (GATT). It is currently partially implemented in Chrome OS, Android M, Linux and Mac
      behind the experimental flag <code>chrome://flags/#enable-web-bluetooth</code>.<br/>

    <script>
      if('serviceWorker' in navigator) {
        navigator.serviceWorker.register('service-worker.js');
      }
    </script>

    <script>
      window.addEventListener('DOMContentLoaded', function() {
        const searchParams = new URL(location).searchParams;
        const inputs = Array.from(document.querySelectorAll('input[id]'));

        inputs.forEach(input => {
          if (searchParams.has(input.id)) {
            input.value = searchParams.get(input.id);
          }
          input.addEventListener('input', function(event) {
            const newSearchParams = new URL(location).searchParams;
            if (event.target.value) {
              newSearchParams.set(input.id, event.target.value);
            } else {
              newSearchParams.delete(input.id);
            }
            history.replaceState({}, '', Array.from(newSearchParams).length ?
                location.pathname + '?' + newSearchParams : location.pathname);
          });
        });
      });
    </script>

    <p>Here, we use the <code>characteristicvaluechanged</code> event listener to handle reading battery level characteristic value. This event listener will
      optionally handle upcoming notifications as well.</p>

    <button id="readBatteryLevel">Read Bluetooth Device's Battery Level</button>
    <button id="startNotifications" disabled>Start Notifications</button>
    <button id="stopNotifications" disabled>Stop Notifications</button>
    <button id="reset">Reset Bluetooth Device</button>

    <script>
      var ChromeSamples = {
        log: function() {
          var line = Array.prototype.slice.call(arguments).map(function(argument) {
            return typeof argument === 'string' ? argument : JSON.stringify(argument);
          }).join(' ');

          document.querySelector('#log').textContent += line + '\n';
        },

        clearLog: function() {
          document.querySelector('#log').textContent = '';
        },

        setStatus: function(status) {
          document.querySelector('#status').textContent = status;
        },

        setContent: function(newContent) {
          var content = document.querySelector('#content');
          while(content.hasChildNodes()) {
            content.removeChild(content.lastChild);
          }
          content.appendChild(newContent);
        }
      };
    </script>


    <h3>Live Output</h3>
    <div id="output" class="output">
      <div id="content"></div>
      <div id="status"></div>
      <pre id="log"></pre>
    </div>


    <script>
      if (/Chrome\/(\d+\.\d+.\d+.\d+)/.test(navigator.userAgent)){
        // Let's log a warning if the sample is not supposed to execute on this
        // version of Chrome.
        if (48 > parseInt(RegExp.$1)) {
          ChromeSamples.setStatus('Warning! Keep in mind this sample has been tested with Chrome ' + 48 + '.');
        }
      }
    </script>




      
        
    <script>var bluetoothDevice;
        var batteryLevelCharacteristic;

        function onReadBatteryLevelButtonClick() {
          requestDevice()
          .then(connectDeviceAndCacheCharacteristics)
          .then(_ => {
            log('Reading Battery Level...');
            return batteryLevelCharacteristic.readValue();
          })
          .catch(error => {
            log('Argh! ' + error);
          });
        }

        function requestDevice() {
          let result = Promise.resolve();
          if (!bluetoothDevice) {
            log('Requesting Bluetooth Device...');
            result = navigator.bluetooth.requestDevice(
              {filters: anyDevice(), optionalServices: ['battery_service']})
            .then(device => {
              bluetoothDevice = device;
            });
          }
          return result;
        }

        function connectDeviceAndCacheCharacteristics() {
          if (bluetoothDevice.gatt.connected && batteryLevelCharacteristic) {
            return Promise.resolve();
          }

          log('Connecting to GATT Server...');
          return bluetoothDevice.gatt.connect()
          .then(server => {
            log('Getting Battery Service...');
            return server.getPrimaryService('battery_service');
          })
          .then(service => {
            log('Getting Battery Level Characteristic...');
            return service.getCharacteristic('battery_level');
          })
          .then(characteristic => {
            batteryLevelCharacteristic = characteristic;
            batteryLevelCharacteristic.addEventListener('characteristicvaluechanged',
                handleBatteryLevelChanged);
            document.querySelector('#startNotifications').disabled = false;
            document.querySelector('#stopNotifications').disabled = true;
          });
        }

        /* This function will be called when `readValue` resolves and
         * characteristic value changes since `characteristicvaluechanged` event
         * listener has been added. */
        function handleBatteryLevelChanged(event) {
          let batteryLevel = event.target.value.getUint8(0);
          log('> Battery Level is ' + batteryLevel + '%');
        }

        function onStartNotificationsButtonClick() {
          log('Starting Battery Level Notifications...');
          batteryLevelCharacteristic.startNotifications()
          .then(_ => {
            log('> Notifications started');
            document.querySelector('#startNotifications').disabled = true;
            document.querySelector('#stopNotifications').disabled = false;
          })
          .catch(error => {
            log('Argh! ' + error);
          });
        }

        function onStopNotificationsButtonClick() {
          log('Stopping Battery Level Notifications...');
          batteryLevelCharacteristic.stopNotifications()
          .then(_ => {
            log('> Notifications stopped');
            document.querySelector('#startNotifications').disabled = false;
            document.querySelector('#stopNotifications').disabled = true;
          })
          .catch(error => {
            log('Argh! ' + error);
          });
        }

        function onResetButtonClick() {
          batteryLevelCharacteristic.removeEventListener('characteristicvaluechanged',
              handleBatteryLevelChanged);
          batteryLevelCharacteristic = null;
          // Note that it doesn't disconnect device.
          bluetoothDevice = null;
          log('> Bluetooth Device reset');
        }

        /* Utils */

        function anyDevice() {
          // This is the closest we can get for now to get all devices.
          // https://github.com/WebBluetoothCG/web-bluetooth/issues/234
          return Array.from('0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ')
              .map(c => ({namePrefix: c}))
              .concat({name: ''});
        }
        </script>



        <script>
      document.querySelector('#readBatteryLevel').addEventListener('click', function() {
        if (isWebBluetoothEnabled()) {
          onReadBatteryLevelButtonClick();
        }
      });

      document.querySelector('#startNotifications').addEventListener('click', function(event) {
        if (isWebBluetoothEnabled()) {
          onStartNotificationsButtonClick();
        }
      });

      document.querySelector('#stopNotifications').addEventListener('click', function(event) {
        if (isWebBluetoothEnabled()) {
          onStopNotificationsButtonClick();
        }
      });

      document.querySelector('#reset').addEventListener('click', function(event) {
        if (isWebBluetoothEnabled()) {
          ChromeSamples.clearLog();
          onResetButtonClick();
        }
      });
    </script>

    <script>
      log = ChromeSamples.log;

      function isWebBluetoothEnabled() {
        if (navigator.bluetooth) {
          return true;
        } else {
          ChromeSamples.setStatus('Web Bluetooth API is not available.\n' +
                                  'Please make sure the Web Bluetooth flag is enabled.');
          return false;
        }
      }
    </script>


        
        <script>
          /* jshint ignore:start */
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
          ga('create', 'UA-53563471-1', 'auto');
          ga('send', 'pageview');
          /* jshint ignore:end */
        </script>


  </body>
</html>
